var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e])},n(t,e)};function t(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var e=function(){return e=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n},e.apply(this,arguments)};function r(n,t){var e="function"==typeof Symbol&&n[Symbol.iterator];if(!e)return n;var r,o,i=e.call(n),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(n){o={error:n}}finally{try{r&&!r.done&&(e=i.return)&&e.call(i)}finally{if(o)throw o.error}}return a}"function"==typeof SuppressedError&&SuppressedError;var o="string",i="boolean",a="number",u="symbol",c="bigint",s="object",f=[s,function(n){var t="string"==typeof n?JSON.parse(n):n,e={};return Object.entries(t).forEach((function(n){var t=r(n,2),o=t[0],i=t[1],a=i.$type,u=i.$value;e[o]=b[a].from(u)})),e},function(n){var t={};return Object.entries(n).forEach((function(n){var e=r(n,2),o=e[0],i=e[1];t[o]=O(i)})),{$type:s,$value:t}}],p="null",l="function",y="array",g=[y,function(n){var t="string"==typeof n?JSON.parse(n):n,e=[];return t.forEach((function(n,t){var r=n.$type,o=n.$value;e[t]=b[r].from(o)})),e},function(n){var t=[];return n.forEach((function(n,e){t[e]=O(n)})),{$type:y,$value:t}}],v=["set",function(n){var t="string"==typeof n?JSON.parse(n):n,e=new Set;return t.forEach((function(n){var t=n.$type,r=n.$value,o=b[t].from(r);e.add(o)})),e},function(n){return{$type:"set",$value:Array.from(n).map((function(n){return O(n)}))}}],d=["map",function(n){var t="string"==typeof n?JSON.parse(n):n,e=new Map;return t.forEach((function(n){var t=r(n,2),o=t[0],i=t[1],a=o.$type,u=o.$value;o=b[a].from(u);var c=i.$type,s=i.$value;i=b[c].from(s),e.set(o,i)})),e},function(n){var t,e,o=n.entries(),i=[];try{for(var a=function(n){var t="function"==typeof Symbol&&Symbol.iterator,e=t&&n[t],r=0;if(e)return e.call(n);if(n&&"number"==typeof n.length)return{next:function(){return n&&r>=n.length&&(n=void 0),{value:n&&n[r++],done:!n}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(o),u=a.next();!u.done;u=a.next()){var c=r(u.value,2),s=c[0],f=c[1],p=O(s),l=O(f);i.push([p,l])}}catch(n){t={error:n}}finally{try{u&&!u.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}return{$type:"map",$value:i}}],h="date",$="regexp",w="undefined",b=[[o,function(n){return n},function(n){return{$type:o,$value:n}}],[i,function(n){return"true"===n},function(n){return{$type:i,$value:n}}],[a,function(n){return+n},function(n){return{$type:a,$value:""+n}}],[u,function(n){return Symbol.for(n)},function(n){return{$type:u,$value:n.description}}],[c,function(n){return BigInt(n)},function(n){return{$type:c,$value:""+n}}],f,[p,function(n){return null},function(n){return{$type:p,$value:""+n}}],[l,function(n){var t=n.startsWith("function")?n:"function "+n;return new Function("...rest","return ("+t+")(...rest)")},function(n){return{$type:l,$value:n.toString()}}],g,v,d,[h,function(n){return new Date(+n)},function(n){return{$type:h,$value:""+n.getTime()}}],[$,function(n){return new RegExp(n)},function(n){return{$type:$,$value:n.source}}],[w,function(){},function(){return{$type:w,$value:"undefined"}}]].reduce((function(n,t){var e,o=r(t,3),i=o[0],a=o[1],u=o[2];return Object.assign(n,((e={})[i]={from:a,to:u},e)),n}),{}),E="BroadcastChannel"in window,m="localStorage"in window,S=function(n){var t=JSON.parse(n),r=t.$payload,o=function(n,t){var e={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&t.indexOf(r)<0&&(e[r]=n[r]);if(null!=n&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(n);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(n,r[o])&&(e[r[o]]=n[r[o]])}return e}(t,["$payload"]),i=e(e({},o),{$payload:{}}),a=r.$type,u=r.$value;return i.$payload=b[a].from(u),i},O=function(n){var t,e=b[(t=n,void 0===t?"undefined":null===t?"null":t.constructor.name.toLowerCase())];return e&&(n=e.to(n)),n},M=function(n,t){var e=O(n);return{$timezone:Date.now(),$origin:location.href,$payload:e,$target:"string"==typeof t?t:null==t?void 0:t.source,$id:x(16)}},j=function(n,t){return!t||new RegExp(t).test(n)},x=function(n){for(var t="";t.length<n;t+=Math.random().toString(36).substr(2));return t.substr(0,n)},C=new Map,B=function(n,t){"string"==typeof n&&(n=[n]),n.forEach((function(n){var e=C.get(n)||new BroadcastChannel(n);e.addEventListener("message",(function(n){try{var e=S(n.data);if(e.$origin===location.href)return;if(!j(location.href,e.$target))return;"function"==typeof t&&t(e)}catch(n){console.error(n)}})),C.set(n,e)}))},_=function(n,t,e){"string"==typeof n&&(n=[n]);var r=M(t,e);n.forEach((function(n){(C.get(n)||new BroadcastChannel(n)).postMessage(JSON.stringify(r))}))},I=function(n,t){"string"==typeof n&&(n=[n]),n.forEach((function(n){var e=C.get(n)||new BroadcastChannel(n);e.addEventListener("messageerror",(function(n){"function"==typeof t&&t(n)})),C.set(n,e)}))},J=function(n){"string"==typeof n&&(n=[n]),n.forEach((function(t){var e=C.get(t);if(!e)throw new Error("the channel named ".concat(n," isn't exist"));e.close(),C.delete(t)}))},N=new Map,L=function(n,t){"string"==typeof n&&(n=[n]),window.addEventListener("storage",(function(e){try{var r=S(e.newValue);if(!j(location.href,r.$target))return;var o=e.key;n.includes(o)&&t(r)}catch(n){console.error(n)}}))},P=function(n,t,e){var r=M(t,e),o=JSON.stringify(r);"string"==typeof n&&(n=[n]),n.forEach((function(n){try{window.localStorage.setItem(n,o)}catch(t){(N.get(n)||[]).forEach((function(n){n(t)}))}}))},T=function(n,t){"string"==typeof n&&(n=[n]),n.forEach((function(n){var e=N.get(n);e?e.push(t):e=[t],N.set(n,e)}))},A=function(n){var t=localStorage.setItem;"string"==typeof n&&(n=[n]),localStorage.setItem=function(e,r){n.includes(e)||t(e,r)};var e=localStorage.getItem;localStorage.getItem=function(t){if(!n.includes(t))return e(t)}},D=function(){},R=function(n){function e(){return null!==n&&n.apply(this,arguments)||this}return t(e,n),e.prototype.onMessage=function(n,t){L(n,t)},e.prototype.onSendMessageError=function(n,t){T(n,t)},e.prototype.sendMessage=function(n,t,e){P(n,t,e)},e.prototype.close=function(n){A(n)},e}(D),k=function(n){function e(){return null!==n&&n.apply(this,arguments)||this}return t(e,n),e.prototype.onMessage=function(n,t){B(n,t)},e.prototype.sendMessage=function(n,t,e){_(n,t,e)},e.prototype.onSendMessageError=function(n,t){I(n,t)},e.prototype.close=function(n){J(n)},e}(D),z=E||m,F=function(){function n(n){if(this.options={engine:"BroadcastChannel"},!z)throw new Error("The library doesn't support your browser.");Object.assign(this.options,n),this.initEngine()}return n.prototype.initEngine=function(){var n=this.options.engine,t={BroadcastChannel:k,LocalStorage:R};this.instance=new t[n](this.options)},n.prototype.onMessage=function(n,t){this.instance.onMessage(n,t)},n.prototype.sendMessage=function(n,t,e){this.instance.sendMessage(n,t,e)},n.prototype.onMessageError=function(n,t){this.instance.onSendMessageError(n,t)},n.prototype.close=function(n){this.instance.close(n)},n}(),V=E||m,W=function(n){if(!V)throw new Error("the lib isn't support your browser.");n=Object.assign({engine:"BroadcastChannel"},n);var t=[{engine:"BroadcastChannel",support:E,onMessage:B,sendMessage:_,onSendMessageError:I,close:J},{engine:"LocalStorage",support:m,onMessage:L,sendMessage:P,onSendMessageError:T,close:A}].find((function(t){return t.engine===n.engine&&t.support}));return{onMessage:function(n,e){return t.onMessage(n,e)},sendMessage:function(n,e,r){return t.sendMessage(n,e,r)},onMessageError:function(n,e){return t.onSendMessageError(n,e)},close:function(n){return t.close(n)}}};export{F as DataSynchronizer,W as useDataSynchronizer};
